\documentclass[5p,times]{elsarticle}
%===============
\usepackage[colorlinks=true,allcolors=blue]{hyperref}
\usepackage{graphicx}

\usepackage{epstopdf}
\usepackage{dcolumn}
\usepackage{bm}
%\usepackage[mathlines]{lineno}
%\linenumbers\relax

\usepackage{xr-hyper}
%\externaldocument{ITIC-supp}
%\externaldocument[S-]{ITIC-supp}

\usepackage[latin1]{inputenc}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows}
\usepackage{hyperref}

%\usepackage{enumitem}

\usepackage[position=top]{subfig}


%===============
\usepackage{lineno,hyperref}

\modulolinenumbers[5]

\journal{Fluid Phase Equilibria}

%%%%%%%%%%%%%%%%%%%%%%%
%% Elsevier bibliography styles
%%%%%%%%%%%%%%%%%%%%%%%
%% To change the style, put a % in front of the second line of the current style and
%% remove the % from the second line of the style you would like to use.
%%%%%%%%%%%%%%%%%%%%%%%

%% Numbered
%\bibliographystyle{model1-num-names}

%% Numbered without titles
%\bibliographystyle{model1a-num-names}

%% Harvard
%\bibliographystyle{model2-names.bst}\biboptions{authoryear}

%% Vancouver numbered
%\usepackage{numcompress}\bibliographystyle{model3-num-names}

%% Vancouver name/year
%\usepackage{numcompress}\bibliographystyle{model4-names}\biboptions{authoryear}

%% APA style
%\bibliographystyle{model5-names}\biboptions{authoryear}

%% AMA style
%\usepackage{numcompress}\bibliographystyle{model6-num-names}

%% `Elsevier LaTeX' style
\bibliographystyle{elsarticle-num}
%%%%%%%%%%%%%%%%%%%%%%%
\hypersetup{draft}
\begin{document}

\begin{frontmatter}

\title{Coexistence Calculation Using the Isothermal-Isochoric Integration Method}

%% Group authors per affiliation:
\author{S. Mostafa Razavi}
\ead{sr87@uakron.edu}
\address{Department of Chemical and Biomolecular Engineering, The University of Akron, Akron, Ohio 44325, USA}

\author{Richard A. Messerly}
\ead{richard.messerly@nist.gov}
\address{Thermodynamics Research Center, National Institute of Standards and Technology, Boulder, Colorado 80305, USA}

%% or include affiliations in footnotes:
%\author[mymainaddress,mysecondaryaddress]{Elsevier Inc}
%\ead[url]{www.elsevier.com}


\author{J. Richard Elliott \corref{mycorrespondingauthor}}
\cortext[mycorrespondingauthor]{Corresponding author}
\ead{elliot1@uakron.edu}
\address{Department of Chemical and Biomolecular Engineering, The University of Akron, Akron, Ohio 44325, USA}

\begin{abstract}
In this work, the isothermal-isochoric integration (ITIC) method is demonstrated as a viable method for vapor-liquid coexistence calculation by molecular simulation. Several tests are carried out to validate the method. The first group of tests utilizes self-consistent NIST REFPROP values to demonstrate that, in the absence of simulation uncertainties, the ITIC method yields coexistence values with less than 1 \% deviation for reduced temperatures of less than 0.85. The impact of various simulation specifications are then compared. Following our recommended simulation methodology, consistent results are achieved between the ITIC method, Gibbs Ensemble Monte Carlo (GEMC) method, and Grand Canonical Monte Carlo (GCMC) method for reduced temperatures of 0.6-0.85. The ITIC method proves to be much more effective compared to GEMC and GCMC methods for vapor-liquid coexistence calculations at reduced temperatures of 0.45-0.6, which are important for practical applications. It is shown that computational efficiency is often served best by applying the ITIC method for the entire temperature range rather than applying Monte Carlo (MC) methods for part of the range. Furthermore, the ITIC method lends itself to application with molecular dynamics (MD) as well as MC, advancing the prospect of simulation results that are quantitatively consistent across software platforms.
\end{abstract}

\begin{keyword}
Vapor Pressure, Vapor Liquid Equilibria, Phase Diagram, Liquid Density
\end{keyword}

\end{frontmatter}

%\linenumbers

\section{Introduction} \label{sec:introduction}
Phase coexistence determination is important when characterizing the physical properties of a chemical compound. Both the vapor pressure ($P^{\mathrm{sat}}$) and saturation liquid and vapor density ($\rho_{\mathrm{liq}}$ and $\rho_{\mathrm{vap}}$) provide sensitive measures of the quality provided by a particular force field. In principle, the computation of phase coexistence is a simple matter of equating pressures, temperatures, and chemical potentials between the coexisting phases. Nevertheless, accurate computation of phase coexistence by molecular simulation has posed challenges over the years. 

The most straightforward method to compute phase transition in molecular simulation is to simply define an $NVT$ system (constant number of molecules, volume, and temperature) of sufficient size and overall density that an explicit interface is encountered. However this method often results in imprecise results \cite{Frenkel1996}. First order phase transitions exhibit a considerable free energy barrier between two phases due to interfacial free energies. For systems with large interfaces, this energy barrier increases. This often results in hysteresis, and phase transformation irreversibly proceeds beyond the coexistence point. \cite{Frenkel1996} 

Alternatively, there are methods for calculating phase coexistence while avoiding explicit interfaces. The Gibbs Ensemble Monte Carlo (GEMC) method \cite{Panagiotopoulos1987} is one of the most popular phase coexistence determination methods \cite{Paluch2008}.  GEMC requires particle exchange between two phases which leads to its major drawback, i.e. insertion of particles in dense phases for large molecules. Histogram reweighting Monte Carlo and Transition-matrix Monte Carlo methods 
are two closely related methods used for calculation of phase equilibrium based on Grand Canonical Monte Carlo (GCMC) simulations. These methods also involve the problematic insertion/deletion moves. This problem is especially exacerbated  at low temperatures and for large and branched molecules. The lowest temperatures that are available in the literature rarely extend below a reduced temperature ($T_\mathrm{r} = T/T_\mathrm{c}$, where $T_\mathrm{c}$ is the critical temperature) of 0.6 \cite{Martin1998,Potoff2009}. However, common methods for industrial applications treat the temperature range from triple point (which may be as low as $T_\mathrm{r}=0.3$) to the critical point. The Peng-Robinson equation of state, for example, is valid for reduced temperatures as low as 0.45 \cite{Peng1976}. To provide fundamental physical models that address issues with industrial applications, molecular simulations must address the entire temperature range of interest. 

As another alternative, Kofke \cite{Kofke1993b} developed a method called Gibbs-Duhem integration which makes use of the Clapeyron equation to numerically integrate and proceed along the saturation line starting from one single coexistence point. This method has been extensively used to extend the lower temperature limit of coexistence calculations much below the normal boiling point \cite{Ahunbay2004} \cite{Vega2009} \citep{Ungerer2000} \cite{Vega2006} \cite{Yiannourakou2018}. The Gibbs-Duhem method can solve the insertion problem, but it relies on a second method to obtain the initial coexistence point. Ahunbay et al. \cite{Ahunbay2004}, for example, have applied this approach in conjunction with GEMC to obtain the initial coexistence point, $NPT$ simulations (constant number of molecules, pressure, and temperature) to estimate saturation liquid densities, and parallel tempering method \cite{Yan1999} to increase the efficiency of low temperature simulations. Their implementation is tested at reduced temperatures above 0.45 for several compounds. Note that in Gibbs-Duhem method, vapor density can also be obtained from the ideal gas equation or through separate $NPT$ simulations at the computed saturation pressure and temperature.

%Ahunbay et al. \cite{Ahunbay2004} have applied this approach in conjunction with GEMC to obtain the initial coexistence point, $NPT$ simulations to estimate saturation liquid densities, and parallel tempering method \cite{Yan1999} to increase the efficiency of low temperature simulations. Their implementation is tested at reduced temperatures above 0.45 for several compounds, however it does not provide saturation vapor density unless it is calculated directly from GEMC simulation.

As one more alternative, thermodynamic integration (TI) can provide a reliable solution for free energy calculation. In this method, a series of simulations are performed along a path that connects the state of interest to a system for which the free energy is known. One should be careful that the path does not include any type of phase change\cite{Vega2009}. Elliott et al. \cite{Elliott1999a} applied an isochoric integration method to calculate vapor-liquid equilibria (VLE) of square well spheres, demonstrating deficiencies in the preceding MC results.  For square well spheres, a convenient starting isotherm is the hard sphere limit, for which the thermodynamics are well represented by the Carnahan-Starling equation\cite{Carnahan1969a}. In this work, however, results are sought for soft potential models of arbitrary molecular shape, for which the infinite temperature limit is not convenient. 

In the proposed method, $NVT$ simulation points are used across an isotherm and along several isochores, hence the name isothermal-isochoric (ITIC) \cite{Razavi2016}. Because the approach to low temperatures proceeds along an isochore initialized at the high temperature (supercritical) isotherm, the insertion move problem is alleviated. In principle, there is no low temperature limit for the applicability of this method, except the triple point. 

Also, the data generated along the paths of integration are valuable on their own merits, providing distinct insights about how well the molecular model is performing under conditions of high temperature and pressure. In other words, ITIC provides greater quality of characterization than other vapor-liquid coexistence calculations at low saturation temperatures and non-saturation temperatures. In addition, with combination of derivative properties from the work of Lustig et al \cite{Lustig2015}, it should be possible to utilize these data in order to generate high accuracy multi-parameter equations of state \cite{Thol2016_LJ,Thol2016_siloxane,Thol2016_siloxane_first,Thol2017,Rutkai2013,Rutkai2015,Thol2015,Thol2015b}.

As another advantage, vapor pressure calculation using molecular dynamics (MD) is often perceived as an impractical approach \cite{Nieto-Draghi2015}. In this work, we show the possibility of using molecular dynamics in the context of ITIC integration as a viable tool for VLE calculation. The ITIC method provides a cross-platform solution to the problem of VLE calculation without a significant increase in computational effort compared to the typical GEMC or GCMC approaches \cite{Razavi2016,Messerly2018}.
 
The presentation is initiated in Section~\ref{sec:ITIC-method} with a review of the thermodynamics underlying the integration method and some practical implementation aspects. The approach is validated in Section~\ref{sec:NIST-VAL} by applying it to coexistence data available from the National Institute of Standards and Technology (NIST). Section~\ref{sec:SimDetail} describes the details of simulations that are found in Sections~\ref{sec:VirialCalc}-\ref{sec:ExampleSim}. Section~\ref{sec:VirialCalc} provides recommendations for the most convenient and effective methods for characterizing the virial coefficients by molecular simulation. Section~\ref{sec:FSE} investigates the impact of system size, fixed or flexible bonds, and Monte Carlo or molecular dynamics when simulating at low densities. Section~\ref{sec:ExampleSim} demonstrates applications to molecular simulations and comparison between the ITIC method and other methods of phase coexistence calculation. Finally, Section~\ref{sec:conclusion} summarizes the conclusions from this work.

\section{The Isothermal-Isochoric Integration Method} \label{sec:ITIC-method}
\subsection{Free energy departure function derivation}
In this section, the dimensionless departure functions defined below are used to represent different forms of energy

\begin{equation}
\begingroup
\large
\begin{array}{l}
{
G^\mathrm{dep}(T,P)=  \frac{\left[G(T,P)-G_\mathrm{ig}(T,P)\right]_\mathrm{T,P}}{RT} 
}
\\
{
A^\mathrm{dep}(T,\rho)=  \frac{\left[A(T,\rho)-A_\mathrm{ig}(T,\rho)\right]_\mathrm{T,\rho}}{RT} 
}
\\
{
U^\mathrm{dep}(T,\rho)=  \frac{ U(T,\rho)-U_\mathrm{ig}(T,\rho)}{RT} 
}
\\
{
H^\mathrm{dep}(T,\rho)=  \frac{ H(T,\rho)-H_\mathrm{ig}(T,\rho)}{RT} 
}
\end{array} 
\endgroup
\label{eqn:DepDefinition}
\end{equation}
where $T$, $\rho$, $P$, and $R$ are temperature, density, pressure, and the gas constant ($8.3144598\,\mathrm{J/(mol\,K)}$), respectively. $G^\mathrm{dep}$, $A^\mathrm{dep}$, and $U^\mathrm{dep}$ represent the Gibbs free energy, Helmholtz free energy, and internal energy departure functions. The subscript ``ig" denotes the ideal gas and the subscripts $T$, $P$, and $\rho$ indicates that these quantities are fixed when defining the departure function, e.g. subscript ``$T,\rho$" means the ideal gas and the real fluid have the same temperature and density. $U^\mathrm{dep}$ and $H^\mathrm{dep}$ requires no subscript because it is the same whether evaluated at $P$ or $\rho$.

For a single component system, Eq.~(\ref{eqn:PhaseEquilbriumCriterion}) must be satisfied at vapor-liquid phase equilibrium
\begin{equation}
\begin{array}{l}
{T_\mathrm{liq} =T_\mathrm{vap} }\\
{P_\mathrm{liq} =P_\mathrm{vap} }\\
{G_\mathrm{liq} =G_\mathrm{vap} }
\end{array} 
\label{eqn:PhaseEquilbriumCriterion}
\end{equation}
where and subscripts ``vap" and ``liq" denote the vapor and liquid phases, respectively. 


The Gibbs energy criterion of phase equilibrium can be rewritten in dimensionless departure function form

%\begin{equation}
%\frac{ \left(G_\mathrm{liq} -G_\mathrm{ig} \right)_{T,P} }{ RT^\mathrm{sat} } =\frac{ \left(G_\mathrm{vap} -G_\mathrm{ig} \right)_{T,P} }{ RT^\mathrm{sat} } 
%\label{eqn:eqn9}
%\end{equation}

\begin{equation}
G^\mathrm{dep}(T_\mathrm{liq},P_\mathrm{liq})
= 
G^\mathrm{dep}(T_\mathrm{vap},P_\mathrm{vap})
\label{eqn:GdepCriteria}
\end{equation}
which can be rearranged in terms of dimensionless Helmholtz energy ($A^\mathrm{dep}$) departure function 
\begin{equation}
A^\mathrm{dep}_\mathrm{liq} + Z_\mathrm{liq}-1 - \ln(Z_\mathrm{liq})
= 
A^\mathrm{dep}_\mathrm{vap} + Z_\mathrm{vap}-1 - \ln(Z_\mathrm{vap})
\label{eqn:AdelCriteria}
\end{equation}
where $A^\mathrm{dep}_\mathrm{liq}=A^\mathrm{dep}(T^\mathrm{sat},\rho_\mathrm{liq})$, $A^\mathrm{dep}_\mathrm{vap}=A^\mathrm{dep}(T^\mathrm{sat},\rho_\mathrm{vap})$, $Z_\mathrm{liq} = Z(T^\mathrm{sat},\rho_\mathrm{liq})$, and $Z_\mathrm{vap} = Z(T^\mathrm{sat},\rho_\mathrm{vap})$.

In Eq.~(\ref{eqn:AdelCriteria}) $Z$ represents the compressibility factor ($Z=P/\rho RT$) and $\ln(Z)$ terms are introduced when converting Gibbs energy departure function at fixed $T,P$ in Eq.~(\ref{eqn:GdepCriteria}) to Helmholtz energy departure function at fixed $T,\rho$ in Eq.~(\ref{eqn:AdelCriteria}) \cite{Elliott1999}. 

Calculating Helmholtz energy departure functions in Eq.~(\ref{eqn:AdelCriteria}) requires connecting the state of interest to the reference state that is ideal gas at saturation temperature. In the ITIC integration method the states of interest (saturated liquid and vapor) are connected to the reference state (ideal gas at saturation temperature) through isochoric and/or isothermal pathways. Several separate simulations in the canonical ensemble ($NVT$) are needed to construct these paths (see Section~\ref{sec:ITIC-state-points}). 

The Helmholtz energy change along an isochoric pathway is calculated by using Eq.~(\ref{eqn:DeltaA-IC}) \cite{Elliott1999}.

\begin{equation}
 \frac{A(T_2,\rho)}{RT_2} -  \frac{A(T_1,\rho)}{RT_1}  = \int _{T_1}^{T_2} \frac{U(T,\rho)}{R}  d\left(\frac{1}{T}\right)
\label{eqn:DeltaA-IC}
\end{equation}
where $\rho$ represents the density of the isochore.

%The Helmholtz energy change along an isothermal pathway with the ideal gas as starting point is calculated using

%\begin{equation}
%\frac{A(T,\rho_2)}{RT} -  \frac{A(T,\rho_1)}{RT}  = \int _{\rho_1}^{\rho_2} \frac{Z(T,\rho)-1}{\rho}  d\rho
%\label{eqn:DeltaA-IT}
%\end{equation}
%where $\rho_1=0$ and $T$ represents the isotherm temperature. Note that Eq.(\ref{eqn:DeltaA-IT}) represents $A^\mathrm{dep}(T,\rho_2)$ if $\rho_1=0$.


The Helmholtz energy departure function change along an isothermal pathway is calculated using

\begin{equation}
A^\mathrm{dep}(T,\rho_2) -  A^\mathrm{dep}(T,\rho_1)  = \int _{\rho_1}^{\rho_2} \frac{Z(T,\rho)-1}{\rho}  d\rho
\label{eqn:DeltaA-IT}
\end{equation}
Note that in the most common application of Eq.(\ref{eqn:DeltaA-IT}) in the ITIC method, the initial point of isotherm has a zero density ($\rho_1 = 0$). Therefore, since Helmholtz energy at zero density equals zero, the left hand side can be written as $A^\mathrm{dep}(T,\rho_2)$.


Saturated vapor is connected through one isothermal path to ideal gas at saturation temperature. Because the density of vapor phase is low at most conditions of interest, the value for $Z_{\mathrm{vap}}$ in Eq.~(\ref{eqn:AdelCriteria}) can be approximated using a virial expansion truncated at the $B_3$ term

\begin{equation}
{Z_{\mathrm{vap}}} = 1 + {B_2}{\rho_{\mathrm{vap}}} + {B_3}\rho_{\mathrm{vap}}^2
\label{eqn:eqn11}
\end{equation}
which is substituted in Eq.~(\ref{eqn:DeltaA-IT}) to obtain

\begin{equation}
\begin{array}{l}
{A^\mathrm{dep}_\mathrm{vap}} =  {B_2}{\rho _{\mathrm{vap}}} + \frac{1}{2}{B_3}\rho _{\mathrm{vap}}^2
\\ 
\end{array} 
\label{eqn:eqn12}
\end{equation}
where $B_2$ and $B_3$ are second and third virial coefficients at saturation temperature.

On the liquid side, the pathway from saturated liquid to ideal gas cannot be constructed using a single isotherm. Instead, in order to avoid the two phase region, the saturated liquid is connected to a supercritical fluid ($T^\mathrm{IT} \approx 1.2 T_{c}$) along an isochoric path, the density of the supercritical state is decreased to zero along an isotherm, and, finally, the ideal gas at supercritical temperature is connected to an ideal gas at the saturation temperature along another isochore.
 
\begin{equation}
\begingroup
\large
\begin{array}{l}
 
A^\mathrm{dep}_\mathrm{liq}
=
\int _{T^{\mathrm{IT}}}^{T^{\mathrm{\mathrm{sat}}}
} \left.\frac{U}{R} \right\vert_{\rho={\rho_\mathrm{liq}}} \mathrm{d} \left(\frac{1}{T} \right)
\\ 
+ \int _{0}^{\rho _{\mathrm{liq}} } \left.\frac{Z-1}{\rho }\right\vert_{T=T^{\mathrm{IT}}} \mathrm{d}\rho + \int _{T^{\mathrm{sat}}}^{T^{\mathrm{\mathrm{IT}}}
} \left. \frac{U}{R} \right\vert_{\rho=0} \mathrm{d} \left(\frac{1}{T} \right) 
\end{array} 
\endgroup
\label{eqn:AdepLiq1}
\end{equation}

Because the last integral is evaluated at zero density, the integrand corresponds to the ideal gas internal energy ($U_\mathrm{ig}$). Therefore, Eq.~(\ref{eqn:AdepLiq1}) can be written as


\begin{equation}
\begingroup
\large
\begin{array}{l}
A^\mathrm{dep}_\mathrm{liq}
=
\\
\int _{T^{\mathrm{IT}}}^{T^{\mathrm{\mathrm{sat}}}
} \left. \frac{U-U_\mathrm{ig}}{R} \right\vert_{\rho=\rho_{\mathrm{liq}}} \mathrm{d} \left(\frac{1}{T} \right) + \int _{0}^{\rho _{\mathrm{liq}} } \left. \frac{Z-1}{\rho } \right\vert_{T=T^{\mathrm{IT}}} \mathrm{d}\rho   
\end{array} 
\endgroup
\label{eqn:AdepLiq2}
\end{equation}

\subsection{Vapor pressure and density calculation}
We have characterized the Helmholtz energy departure function in vapor and liquid phases. Substituting Eqs.~(\ref{eqn:eqn11}-\ref{eqn:eqn12}) in Eq.~(\ref{eqn:AdelCriteria}) yields


\begin{equation}
A^\mathrm{dep}_\mathrm{liq}
+ {Z_{\mathrm{liq}}} - 1 + \ln \left( \frac{{{\rho _{\mathrm{liq}}}}}{{{\rho _{\mathrm{vap}}}}} \right) = 2{B_2} {\rho _{\mathrm{vap}}} + \frac{3}{2}{B_3} \rho _{\mathrm{vap}}^2 
\label{eqn:eqn14}
\end{equation}
which can be rearranged in terms of ${\rho_\mathrm{vap}}$ 

\begin{equation}
\rho _{\mathrm{vap}} = \rho _\mathrm{liq} \exp \left( A^\mathrm{dep}_\mathrm{liq} + {Z_{\mathrm{liq}}} - 1 - 2{B_2} {\rho _{\mathrm{vap}}} - \frac{3}{2}{B_3} \rho _{\mathrm{vap}}^2
\right)
\label{eqn:rhoV}
\end{equation}
Since $\rho_\mathrm{vap}$ appears on both sides of Eq.~(\ref{eqn:rhoV}), this equation can be solved iteratively, as explained in detail in Section~\ref{sec:ITIC-algorithm}. 

Finally, assuming $\rho_\mathrm{vap}$, $T^\mathrm{sat}$, and virial coefficients at $T^\mathrm{sat}$ are known, vapor pressure ($P^\mathrm{sat}$) can be calculated using

\begin{equation}
\begin{array}{l}
P^\mathrm{sat} = P_\mathrm{vap} = {Z_\mathrm{vap}}{\rho _\mathrm{vap}}RT^\mathrm{sat}
\\
= (1 + {B_2} {\rho_\mathrm{vap}} + {B_3}\rho _\mathrm{vap}^2){\rho _\mathrm{vap}}RT^\mathrm{sat} 
\end{array}
\label{eqn:psat}
\end{equation}


\subsection{ITIC algorithm}\label{sec:ITIC-algorithm}
Implementation of the ITIC procedure starts with determining the temperatures and densities of the ITIC points shown in Figure~\ref{fig:ITICpathway}. In ITIC method, $\rho_\mathrm{liq}$ is imposed and $T^\mathrm{sat}$, $P^\mathrm{sat}$, and $\rho_\mathrm{vap}$ are calculated. This involves estimating saturation temperatures ($T^\mathrm{sat}_\mathrm{est}$), i.e. $T$ at points 11, 13, 15, 17, and 19. Once ITIC state points are determined, $NVT$ simulations are performed at the obtained conditions using either MD or MC, and the ensemble averages of $Z$ and $U^\mathrm{dep}$ are calculated from simulation output. $A^\mathrm{dep}_\mathrm{liq}$ is then calculated as explained in Section~\ref{sec:ITIC-state-points}. 

The first iteration starts by setting $Z_\mathrm{liq}$ to an initial value of zero (After the first iteration, $Z_\mathrm{liq}$ is updated with the value from previous iteration). Next, $T^\mathrm{sat}$ is calculated by inter- or extrapolating the isochoric simulation results, specifically, we fit Z vs reciprocal temperature to a second order polynomial and solve for $T^\mathrm{sat}$ such that $Z(T^\mathrm{sat})=Z_\mathrm{liq}$. It should be noted that iterations of $T^\mathrm{sat}$ do not require further simulations because the isochoric integration can be performed with interpolated values of the compressibility factor, noting the smooth behavior of $Z$ vs. reciprocal temperature.

Since the value of $T^\mathrm{sat}$ has changed, $U^\mathrm{dep}_\mathrm{liq}$ and $A^\mathrm{dep}_\mathrm{liq}$ should be recomputed. $U^\mathrm{dep}_\mathrm{liq}$ is updated by inter- or extrapolating $U^\mathrm{dep}T$ vs $1/T$ (i.e. $(U-U^\mathrm{ig})/R$ vs. $1/T$ in Eq.~\ref{eqn:AdepLiq2}) using a first order polynomial along the isochore, such that $U^\mathrm{dep}_\mathrm{liq,new} = U^\mathrm{dep}(T^\mathrm{sat}_\mathrm{new})$. Becuase $U^\mathrm{dep}T$ vs. $1/T$ has a linear shape in the vicinity of $T^\mathrm{sat}$, trapezoid rule is used to update $A^\mathrm{dep}_\mathrm{liq}$ according to the following equation

\begin{equation}
A^\mathrm{dep}_\mathrm{liq,new} = A^\mathrm{dep}_\mathrm{liq,old} + \left( \frac{1}{T^\mathrm{sat}_\mathrm{new}}-\frac{1}{T^\mathrm{sat}_\mathrm{old}} \right) \frac{U^\mathrm{dep}_\mathrm{new}T^\mathrm{sat}_\mathrm{new}+U^\mathrm{dep}_\mathrm{old}T^\mathrm{sat}_\mathrm{old}}{2} 
\label{eqn:aDepCorrection}
\end{equation}
where subscript ``old" denotes the corresponding property at $T^\mathrm{sat}_\mathrm{old}$ and subscript ``new" denotes the property at updated $T^\mathrm{sat}_\mathrm{new}$ (For the first iteration, $T^\mathrm{sat}_\mathrm{old} = T^\mathrm{sat}_\mathrm{est}$). 

At this point, all terms on the right-hand side of Eq.~(\ref{eqn:rhoV}) are known except $\rho_\mathrm{vap}$. For the the first iteration, $\rho_\mathrm{vap}$ on the right-hand side of Eq.~(\ref{eqn:rhoV}) is set to zero and the new vapor density ($\rho_\mathrm{vap}^\mathrm{new}$) is calculated. After the first iteration, $\rho_\mathrm{vap}$ on the right-hand side is updated with $\rho_\mathrm{vap}^\mathrm{old}$ from previous iteration. 

Then, $P^\mathrm{sat}$ is computed by substituting the new $\rho_\mathrm{vap}$ in Eq.~(\ref{eqn:psat}) and the new value of $Z_\mathrm{liq}$ is calculated using

\begin{equation}
{Z_{\mathrm{liq}}} = \frac{P^\mathrm{sat}}{\rho_\mathrm{liq}RT^\mathrm{sat}}  
\label{eqn:zliq}
\end{equation}
where $\rho_\mathrm{liq}$ is equal to the isochoric density.

Having new value for $Z_{\mathrm{liq}}$, the next iteration starts by calculating the new $T^\mathrm{sat}$. The iterations are stopped when the difference in two consecutive $\rho_\mathrm{vap}$ values are less than a defined tolerance (We use 0.1 \% deviation as the stopping criterion. Using smaller tolerances does not significantly improve the accuracy.) This procedure is repeated for other isochores. Figure~2 illustrates a detailed step-by-step algorithm starting from determining ITIC state points to obtaining VLE properties. As shown in this figure, the iterations discussed above do not involve performing additional molecular simulations, rather the iterative solution of the ITIC equations is performed post-simulation. 

The algorithm in Figure~2 also includes a step for obtaining second virial coefficient along isotherm ($B_2^\mathrm{IT}$) and saturation second virial coefficients ($B_2^\mathrm{sat}$) which is explained in Section~\ref{sec:VirialCalc}.
\begin{figure}
\includegraphics[scale=0.48]{Figures/ITIC-pathway-C2-5.png}
\caption{A schematic plot of the ITIC state points. Squares and diamonds represent $NVT$ state points obtained from simulation. Square points 11, 13, 15, 17, and 19 represent the initial estimated $T^\mathrm{sat}$ values, therefore they do not necessarily match the coexistence curve. Green and purple diamonds show the state points required for $B_2$ calculation at isothermal temperature and $T_\mathrm{r}=0.9$, respectively. Red points show the saturated vapor and liquid obtained from ITIC method.}
\label{fig:ITICpathway}
\end{figure}


\begin{figure}[]
\centering
\tikzstyle{decision} = [diamond, draw, fill=blue!20, text width=7em, text badly centered, node distance=2cm, inner sep=0pt]
\tikzstyle{block} = [rectangle, draw, fill=blue!20, text width=19em, text centered, rounded corners, minimum height=1em]
\tikzstyle{block22} = [rectangle, draw, fill=blue!20, text width=19em, text centered, rounded corners, minimum height=1em]
\tikzstyle{block15} = [rectangle, draw, fill=blue!20, text width=15em, text centered, rounded corners, minimum height=1em]
\tikzstyle{smallblock} = [rectangle, draw, fill=blue!20, text width=7em, text centered, rounded corners, minimum height=1em]
\tikzstyle{smallblock2} = [rectangle, draw, fill=blue!20, text width=7em, text centered, rounded corners, minimum height=1em]
\tikzstyle{smallblock3} = [rectangle, draw, fill=blue!20, text width=19em, text centered, rounded corners, minimum height=1em]
\tikzstyle{line} = [draw, -latex']
%\footnotesize Determine $\rho$ and $T$ values in Figure~\ref{fig:ITICpathway}:

\begin{tikzpicture}[node distance = 1.5cm, auto,thick,scale=0.8, every node/.style={scale=0.8}]

\node [block22] (pre0) {
\footnotesize Choose $\rho^9$ and calculate all other densities ($\rho^{1-8}$ and $\rho$ for diamond points in Figure~1)};

\node [block22,below of=pre0,node distance=1.5cm] (pre1) {
\footnotesize Estimate $T^\mathrm{sat}_\mathrm{est}$ ($T^{11,13,15,17,19}$), calculate $T^\mathrm{IT}$, $T^\mathrm{0.9}$ and calculate $T^\mathrm{mid}$ ($T^{10,12,14,16,18}$)};

\node [smallblock3, below of=pre1,node distance=1.3cm] (runNvtIT) {\footnotesize 
Run $NVT$ simulations on IT's, calculate $Z$ and $U^\mathrm{dep}$};

\node [block,below of=runNvtIT,node distance=1cm] (b2step) {\footnotesize 
Calculate $B_2^\mathrm{IT}$ (Eq.~\ref{eqn:Z1rhoB2B3}) and $B_2^\mathrm{sat}$ correlation (Section~\ref{sec:VirialCalc})};

\node [block,below of=b2step,node distance=1.2cm] (runNvtIC) {\footnotesize 
For each IC, run $NVT$ simulations at $T^\mathrm{sat}_\mathrm{est}$ and $T^\mathrm{mid}$ (e.g. $T^\mathrm{10,11}$), calculate $Z$ and $U^\mathrm{dep}$};

\node [block,below of=runNvtIC,node distance=1.2cm] (itartIcIteration) {\footnotesize 
Calculate $A^\mathrm{dep}_\mathrm{liq}$ based on $T^\mathrm{sat}=T^\mathrm{sat}_\mathrm{est}$ (Eq.~\ref{eqn:AdepLiq2})};

\node [block,below of=itartIcIteration,node distance=2cm] (step4) {\footnotesize 
Calculate $T^\mathrm{sat}_\mathrm{new}$ from $Z$ vs. $1/T$  such that $Z(T^\mathrm{sat}) = Z_\mathrm{liq}$ };

\node [block,below of=step4,node distance=1cm] (stepUdep) {\footnotesize 
Calculate $U^\mathrm{dep}_\mathrm{liq,new}$ from $U^\mathrm{dep}_\mathrm{liq}$ vs. $1/T$, i.e., $U^\mathrm{dep}_\mathrm{liq}(T^\mathrm{sat}_\mathrm{new})$ };

\node [block,below of=stepUdep,node distance=1cm] (itartIcIterationa) {\footnotesize 
Calculate $A^\mathrm{dep}_\mathrm{liq}$ (Eq.~\ref{eqn:aDepCorrection}) based on $T^\mathrm{sat}_\mathrm{new}$};

\node [block,below of=itartIcIterationa,node distance=1cm] (step6) {\footnotesize 
Calculate $\rho_\mathrm{vap}^\mathrm{new}$= RHS of Eq.~\ref{eqn:rhoV} evaluated with $\rho_\mathrm{vap}^\mathrm{old}$};

\node [block,below of=step6,node distance=1cm] (step6b) {\footnotesize 
Calculate $P^\mathrm{sat}$ (Eq.~\ref{eqn:psat})};

\node [decision,below of=step6b,node distance=2.3cm] (step8) {\footnotesize 
$|\rho_\mathrm{vap}^\mathrm{new}-\rho_\mathrm{vap}^\mathrm{old}|<tol$ ?};

\node [decision,below of=step8,node distance=3.5cm] (DecideTsat) {\footnotesize 
$|T^\mathrm{sat}-T^\mathrm{sat}_\mathrm{est}|<tol$ ?};

\node [smallblock,right of=step8,node distance=4.0cm] (step7) {\footnotesize 
Update $Z_\mathrm{liq}$ (Eq.~\ref{eqn:zliq}) Set $\rho_\mathrm{vap}^\mathrm{old}=\rho_\mathrm{vap}^\mathrm{new}$};

\node [smallblock2,left of=DecideTsat,node distance=3.8cm] (IterateTsat) {\footnotesize 
Update $T^\mathrm{sat}_\mathrm{est}$ Calculate $T^\mathrm{mid}$};

\node [block15,below of=DecideTsat,node distance=2.5cm] (Report) {\footnotesize 
Report $P^\mathrm{sat}$, $T^\mathrm{sat}$, $\rho_\mathrm{vap}$, and $\rho_\mathrm{liq}$ for IC};

\path [line] (pre0) -- (pre1);
\path [line] (pre1) -- (runNvtIT);
\path [line] (runNvtIT) -- (b2step);
\path [line] (b2step) -- (runNvtIC);
\path [line] (runNvtIC) -- (itartIcIteration);
\path [line] (itartIcIteration) -- node {\footnotesize Set $Z_\mathrm{liq}=0.0$, $\rho_\mathrm{vap}^\mathrm{old}=0.0$}(step4);
\path [line] (step4) -- (stepUdep);
\path [line] (stepUdep) -- (itartIcIterationa);
\path [line] (itartIcIterationa) -- (step6);
\path [line] (step6) -- (step6b);
\path [line] (step6b) -- (step8);
\path [line] (step8) -- node {yes} (DecideTsat);
\path [line] (step8) -- node {no} (step7);
\path [line] (DecideTsat) -- node {yes}(Report);
\path [line] (DecideTsat) -- node {no} (IterateTsat);
\path [line] (IterateTsat) |- (runNvtIC);
\path [line] (step7) |- (step4);
\path [line] (Report.east) -- +(2.7,0) |- node[pos=0.01] {Next IC}(runNvtIC);

\end{tikzpicture}
\label{ITIC-algorithm}
\caption{Algorithm to obtain VLE from $NVT$ simulations using ITIC method}
\end{figure}




\subsection{ITIC state points and integration schemes}\label{sec:ITIC-state-points}
Figure~\ref{fig:ITICpathway} provides a schematic plot of ITIC state points. The minimal number of data points on each path required to achieve reliable results is determined. 
%In order to reach the densities of interest and maintain an acceptable accuracy of VLE data to a reduced temperature of 0.45, one needs at least 9 data points on the isotherm and three data points on the isochore for each saturation point. 
In order to estimate VLE data to a reduced temperature of 0.45 with precision comparable to that of GEMC and GCMC methods, one needs at least 9 data points on the isotherm and three data points on the isochore for each saturation point (see Section \ref{sec:NIST-VAL}).
The highest temperature state points, however, can serve on both isochores and isotherm, hence these points are only simulated once. The isotherm is constructed at a supercritical temperature. A reduced temperature of $T_\mathrm{r} \approx 1.2$ was the default value for the isotherm. For some compounds, owing to lack of NIST REFPROP values at high temperatures and the desire to compare isochores and isotherms to NIST REFPROP values when possible, a lower reduced temperature ($T_\mathrm{r} \approx 1.05$) is chosen for the isotherm. Validations against NIST REFPROP values show that any reduced temperature from 1.05 to 1.2 led to acceptable accuracy (results not presented here).


The integrations along the isotherm and isochores are performed using Simpson's rule \cite{atkinson2008}, due to its simplicity compared with other integration schemes as well as the possibility to use fixed step size for the integration so that simulations can be re-used for different isochores. Eq.~(\ref{eqn:eqn18}) and Eq.~(\ref{eqn:eqn19}) are
articulations of Simpson's rule used for numerical integration along the isotherm and isochores to calculate $A^{\mathrm{dep}}$ by Eq.~(\ref{eqn:AdepLiq2}).

\begin{equation}
\int\limits_a^b {f(x)\mathrm{d} x \approx \frac{{b - a}}{6}} \left[ {f(a) + 4f \left( \frac{{a + b}}{2} \right) + f(b)} \right] \label{eqn:eqn18}
\end{equation}

\begin{equation}
\begin{array}{l}
{\int\limits_a^b f(x)\mathrm{d}x \approx }
\\ 
{{\frac{{b - a}}{8} \left[ {f(a) + 3f \left( \frac{{b - a}}{3} \right) + 3f \left( \frac{{2(b - a)}}{3} \right) + f(b)} \right]}}  
\end{array}
\label{eqn:eqn19}
\end{equation}

The $A^{\mathrm{dep}}$ values at points 2, 4, 7, and 9 in Figure~\ref{fig:ITICpathway} are sequentially calculated using Eq.~(\ref{eqn:eqn18}) in which the value of function at three equidistant points on the x-axis are needed. The $A^{\mathrm{dep}}$ values at points 3, 5, and 8 are sequentially calculated using Eq.~(\ref{eqn:eqn19}) in which the value of the function at four equidistant points on the $x$ axis are needed. The $A^{\mathrm{dep}}$ at point 6 is equal to the integration value from point 6 to point 8 (from Eq.~(\ref{eqn:eqn18})) subtracted from the $A^{\mathrm{dep}}$ value at point 8. The $A^{\mathrm{dep}}$ value at point 1 is equal to the integration value from point 1 to point 4 (from Eq.~(\ref{eqn:eqn19})) subtracted from $A^{\mathrm{dep}}$ value at point 4. 

Second virial coefficient at a given temperature can be estimated by extrapolating $(Z-1)/\rho$ to $\rho=0$ at that temperature. The green and purple diamonds in Figure~\ref{fig:ITICpathway} are used to obtain the intercept of $(Z-1)/\rho$ vs. density at isothermal temperature and $T_{\mathrm{r}}=0.9$, respectively (represented by green and purple squares). These values are used to obtain a $B_2$ correlation as a function of temperature. The green square is also used to obtain $A^\mathrm{dep}$ at point 2. In Section \ref{sec:VirialCalc}, a more detailed discussion of obtaining virial coefficient is provided.

\subsection{Enthalpy of Vaporization Calculation}\label{sec:HvapCalc}
In the ITIC method, enthalpy of vaporization ($\Delta H_\mathrm{v}$) is calculated using
\begin{equation}
\Delta H_\mathrm{v}= ( H^{\mathrm{dep,sat}}_\mathrm{vap} - H^{\mathrm{dep,sat}}_\mathrm{liq})RT
\label{eqn:Hvap}
\end{equation}
where $H^{\mathrm{dep,sat}}_\mathrm{vap}$ and $H^{\mathrm{dep,sat}}_\mathrm{liq}$ are unitless enthalpy departure functions of saturated vapor and liquid, respectively.
%, defined as
%\begin{equation}
%H^{\mathrm{dep}}=\frac{H-H^{\mathrm{ig}}}{RT}
%\label{hdep}
%\end{equation}
$H^{\mathrm{dep,sat}}_\mathrm{vap}$ and $H^{\mathrm{dep,sat}}_\mathrm{liq}$  can be calculated by subtracting the ideal gas contribution from both sides of $H=U+PV$

\begin{equation}
H^{\mathrm{dep,sat}}_\mathrm{liq} \approx U^{\mathrm{dep, sat}}_\mathrm{liq}+Z_\mathrm{liq} - 1
\label{eqn:HsatLiq}
\end{equation}

\begin{equation}
H^{\mathrm{dep,sat}}_\mathrm{vap} \approx U^{\mathrm{dep, sat}}_\mathrm{vap}+Z_\mathrm{vap} - 1
\label{eqn:HsatVap}
\end{equation}

The value of $U^{\mathrm{dep, sat}}_\mathrm{liq}$ is calculated at each iteration based on the updated value of $T^{\mathrm{sat}}$. $U^{\mathrm{dep, sat}}_\mathrm{vap}$, on the other hand, is calculated by taking the derivative of $B_2$ with respect to $\beta$ as shown in Eq.~(\ref{eqn:dB2dbeta}).
\begin{equation}
U^{\mathrm{dep, sat}}_\mathrm{vap}\approx \rho_{\mathrm{vap}} \beta \frac{dB_2}{d\beta}
\label{eqn:dB2dbeta}
\end{equation}

\subsection{Critical Point Calculation}\label{sec:PcCalc}
We follow the standard approach used in GEMC and GCMC methods to calculate the critial point. The critical temperature and critical density ($\rho_\mathrm{c}$) are estimated by the law of rectilinear diameter \cite{Rowlinson1982} and the density scaling law \cite{Rowlinson2013}

\begin{equation}
\frac{\rho_{\mathrm{liq}} +\rho_{\mathrm{vap}}}{2}=\rho_\mathrm{c}+A(T_\mathrm{c}-T^{\mathrm{sat}})
\label{eqn:rectilinearLaw}
\end{equation}

\begin{equation}
\rho_{\mathrm{liq}} -\rho_{\mathrm{vap}}=B(T_\mathrm{c}-T^{\mathrm{sat}})^{0.325}
\label{eqn:scalingLaw}
\end{equation}
where $\rho_\mathrm{c}$, $ T_\mathrm{c}$, $A$ and $B$ are fit to simulation data.

%Critical pressure ($P_\mathrm{c}$) and acentric factor ($\omega$) are calculated from Eq.(\ref{eqn:Lee-Kesler}) \cite{Lee1975} by fitting vapor pressure and saturation temperatures.
			
%\begin{equation}
%{\ln \frac{P}{P_\mathrm{c}}=f^{(0)}+\omega f^{(1)}} 
%\label{eqn:Lee-Kesler}
%\end{equation}
%where $f^{(0)}$ and $f^{(1)}$ terms are defined as
%\begin{equation}
%\begin{array}{l} 
%{f^{(1)} = 15.2518 - \frac{15.6875}{T_\mathrm{r}} - 13.4721 \, \ln(T_\mathrm{r}) +   0.4357 \, T_\mathrm{r}^6 } \\ 
%{ f^{(0)} = 5.9271 - \frac{6.0964}{T_\mathrm{r}} - 1.2886 \, \ln(T_\mathrm{r}) + 0.16934 \, T_\mathrm{r}^6  } 
%\end{array} \label{eqn:Lee-Kesler-terms}
%\end{equation}


The critical pressure $(P_{\rm c})$ is computed in two steps. The first step is to fit the ITIC saturation temperatures $(T^{\rm sat})$ and pressures $(P^{\rm sat})$ to the Antoine equation \cite{rowlinson2013liquids}
\begin{equation} \label{eqn:Antoine}
\log_{10}(P^{\rm sat}) = a_0 + \frac{a_1}{a_2 + T^{\rm sat}}
\end{equation} 
where $a_i$ are fitting constants and $a_1$ is constrained to be negative. The second step is to evaluate Eq.(\ref{eqn:Antoine}) with the optimal values of $a_i$ for $T^{\rm sat} = T_{\rm c}$. 

Some caution should be exercised when extrapolating Eqs.(\ref{eqn:rectilinearLaw}-\ref{eqn:Antoine}) because ITIC data are typically not available near the critical point. For example, we recommend excluding low temperature ITIC data ($T_{\rm r} < 0.6$) when fitting Eqs.(\ref{eqn:rectilinearLaw}-\ref{eqn:Antoine}) as these equations are typically not reliable over the entire temperature range. The results in Section ~\ref{sec:ExampleSim} demonstrate that, although ITIC is generally limited to $T_{\rm r} < 0.85$, careful application of Eqs.(\ref{eqn:rectilinearLaw}-\ref{eqn:Antoine}) provides reasonable estimates for all three critical constants.








\section{ITIC Validation}\label{sec:NIST-VAL}
\subsection{Validation using NIST REFPROP} 
A first test to validate the ITIC method is to use a database that provides precise and self-consistent saturation properties and isochoric/isothermal properties. NIST Reference Fluid Properties software (REFPROP) provides such values \cite{LEMMON-RP91}, which were used to validate the ITIC method. The following comparisons are solely based on NIST REFPROP equations, therefore the lack of statistical noise inherent to molecular simulation enables an accurate evaluation of the numerical integration. Reproducing the REFPROP $P^{\mathrm{sat}}$ values using ITIC state points obtained from REFPROP is effectively a test of the spacing of the quadrature points since all the REFPROP thermodynamics derive exactly from their analytical equation of state.

Figure~\ref{fig:NIST-VALIDATION_C12_FTT} shows the ITIC validation results for \textit{n}-dodecane when virial expansion in Eq.~(\ref{eqn:eqn11}) includes or excludes the $B_{3}$ term. The deviations of calculated $P^{\mathrm{sat}}$, $\rho_{\mathrm{liq}}$, $\rho_{\mathrm{vap}}$, and $\Delta H_{\mathrm{v}}$ from the data obtained directly from NIST REFPROP \cite{Lemmon2004} are plotted in Figure~\ref{fig:Nist-Val-Deviation}. According to this figure, by including the $B_3$ term, one can reach a reduced saturation temperature ($T_\mathrm{r}^{\mathrm{sat}}$) of 0.9 with less than 1 \% error in all saturation properties. The ITIC method is not able to calculate accurate saturation properties when $T_\mathrm{r}^{\mathrm{sat}}>0.9$. If the $B_3$ term is excluded from Eq.~(\ref{eqn:eqn11}), the ITIC method does not converge for $T_\mathrm{r}^{\mathrm{sat}} > 0.85$. When $T_\mathrm{r}^{\mathrm{sat}} < 0.85$, excluding the $B_3$ term provides less than 1 \% deviation in $P^{\mathrm{sat}}$, $\rho_{\mathrm{liq}}$, and $\Delta H_{\mathrm{v}}$ , and less than 2.5 \% deviation in $\rho_{\mathrm{vap}}$.

Figure~\ref{fig:convergence-path}(a) illustrates the convergence paths taken by a the ITIC iterations to calculate $\rho_{\mathrm{vap}}$, with $B_3$ included in Eq~(\ref{eqn:eqn11}). Figure~\ref{fig:convergence-path}(b) shows the same plot, except $B_3$ is excluded, i.e. virial expansion in Eq.~(\ref{eqn:eqn11}) is truncated at $B_{2}$ term. Using $B_3$ corrects the curve representing the right-hand side of Eq.~(\ref{eqn:rhoV}) in such a way that the iterations converge.

\begin{figure*}
\centering
\subfloat[]{\includegraphics[scale=0.25]{Figures/Nist-Validation-CoexistencePlots_psat.png}}
\subfloat[]{\includegraphics[scale=0.25]{Figures/Nist-Validation-CoexistencePlots_trho.png}}
\caption{\textit{n}-Dodecane Clausius-Clapeyron and coexistence curves. ITIC results (symbols) are obtained using NIST REFPROP \cite{Lemmon2004} values for $U^{\mathrm{dep}}$ and $Z$. Circles and triangles represent ITIC results when virial expansion in Eq.~(\ref{eqn:eqn11}) is truncated at $B_2$ and $B_3$ terms, respectively. Solid line represents true NIST REFPROP VLE data.
}
\label{fig:NIST-VALIDATION_C12_FTT}
\end{figure*}


\begin{figure*}
\centering
\subfloat[]{\includegraphics[scale=0.22]{Figures/Nist-Val-Deviation-Psat.png}}
\subfloat[]{\includegraphics[scale=0.22]{Figures/Nist-Val-Deviation-rhoL.png}}\
\subfloat[]{\includegraphics[scale=0.22]{Figures/Nist-Val-Deviation-rhoV.png}}
\subfloat[]{\includegraphics[scale=0.22]{Figures/Nist-Val-Deviation-Hvap.png}}
\caption{
Accuracy of the ITIC method for \textit{n}-dodecane when Eq.~(\ref{eqn:eqn11}) is truncated at $B_2$ and $B_3$ term. If $B_3$ is excluded the ITIC iteration does not converge, when $T_\mathrm{r}^{\mathrm{sat}}>0.9$. Y-axis represents deviations calculated using $\frac{\mathrm{ITIC - REFPROP}}{\mathrm{REFPROP}} \times 100$, which compares ITIC results using REFPROP state points with REFPROP coesistence data.
}
\label{fig:Nist-Val-Deviation}
\end{figure*}


\begin{figure*}
\centering
\subfloat[]{\includegraphics[scale=0.22]{Figures/NIST-VAL_FTT_C12_conv_0_42690.png}}
\subfloat[]{\includegraphics[scale=0.22]{Figures/NIST-VAL_FTF_C12_conv_0_42690.png}}
\caption{
The ITIC iteration and convergence path for \textit{n}-dodecane for the isochore corresponding to $\rho_{\mathrm{liq}}=0.4269\,\mathrm{g/cm^3}$ ($T_\mathrm{r}^\mathrm{sat} \approx 0.94$). The y-axis represents the right-hand side of Eq.~(\ref{eqn:rhoV}). At each iteration, the $y$ curve is plotted based on a new set of $T^{\mathrm{sat}}$, $P^{\mathrm{sat}}$, $A^\mathrm{dep}$, and $Z_{\mathrm{liq}}$. Iteration starts with a low initial guess for $\rho_{\mathrm{vap}}$ and stops when absolute percent deviation between two consecutive $\rho_{\mathrm{vap}}$ values is less than a small tolerance, e.g. 0.1 \%.
The blue line represents the 45-degree line. \textbf{a)} $B_3$ term is used in Eq.~(\ref{eqn:eqn11})
, \textbf{b)} $B_3$ term is excluded from Eq.~(\ref{eqn:eqn11}). Using $B_3$ helps iteration to converge for high $T^{\mathrm{sat}}$ values.}
\label{fig:convergence-path}
\end{figure*}

\subsection{Vapor Pressure Sensitivity to Virial Coefficients} \label{sec:Bx-Sensitivity}
In this section, we investigate the sensitivity of vapor pressure to accuracy of $B_2$ and $B_3$ at saturation temperatures as well as $B_2$ at supercritical isothermal temperature. This is important because $B_2$ and $B_3$ are often unknown for a given force field. 

In order to estimate the required accuracy of the second virial coefficient at the isothermal temperature, Figure~\ref{fig:B2-sensitivity}(a) is generated by changing the REFPROP $B_2$ and calculating the corresponding deviations in \textit{n}-dodecane vapor pressure. For example, a 5 \% change in $B_2$ results in around 2 \% deviation in \textit{n}-dodecane $P^{\mathrm{sat}}$. This shows that it is imperative to use an accurate $B_2$ value at the isothermal temperature.

Vapor pressure estimate is very weakly influenced at low saturation temperatures by accuracy of the second and third virial coefficients in Eq.~(\ref{eqn:rhoV}) and Eq.~(\ref{eqn:psat}). Figure~\ref{fig:B2-sensitivity}(b) shows the $P^{\mathrm{sat}}$ sensitivity to $B_2$ at various reduced temperatures, each representing one isochore. The first three lowest temperatures, are fairly insensitive to $B_2$ precision such that even 50 \% error in $B_2$ results in less than 1 \% deviation in $P^{\mathrm{sat}}$. However, a relatively accurate $B_2$ is required to obtain accurate $P^{\mathrm{sat}}$ when $T_\mathrm{r}^\mathrm{sat}>0.75$. Similarly, when $T_\mathrm{r}^\mathrm{sat} \approx 0.84$ $B_2$ deviations must not be greater than 2 \% in order to have less than 1 \% error in vapor pressure.

Figure~\ref{fig:B2-sensitivity}(c) was plotted similar to Figure~\ref{fig:B2-sensitivity}(b), with respect to $B_3$. It is worth mentioning that in order to truly understand the influence of $B_3$, exact values of $B_2$ were used from NIST REFPROP. Even though adding $B_3$ improves the overall behavior of the ITIC iteration in terms of convergence (Figure~\ref{fig:convergence-path}), the sensitivity of $P^{\mathrm{sat}}$ to $B_3$ is negligible when $T_\mathrm{r}^\mathrm{sat}$ is less than 0.85. This supports the idea of setting the $B_3$ term to zero without significant loss of precision at such temperatures. 

Similar to Figure~\ref{fig:B2-sensitivity}, the effect of changing virial coefficients on $\rho_\mathrm{vap}$ and $T^\mathrm{sat}$ was considered. The sensitivity of $\rho_\mathrm{vap}$ to virial coefficients is similar to $P^\mathrm{sat}$, and $T^\mathrm{sat}$ was found to be insensitive to virial coefficient deviations.

\begin{figure*}
\centering
\subfloat[]{\includegraphics[scale=0.22]{Figures/FTF-B2xX-IT-C12-Psat.png}}
\subfloat[]{\includegraphics[scale=0.22]{Figures/FTF-B2xX-C12-Psat.png}}
\subfloat[]{\includegraphics[scale=0.22]{Figures/FTT-B3xX-C12-Psat.png}}
\caption{
\textbf{a)} \textit{n}-Dodecane $P^{\mathrm{sat}}$ sensitivity to isotherm $B_2$
,\textbf{b)} $P^{\mathrm{sat}}$ sensitivity to second virial coefficient used in Eq.~(\ref{eqn:psat})
, and \textbf{c)} $P^{\mathrm{sat}}$ sensitivity to third virial coefficient used in Eq.~(\ref{eqn:psat})
}
\label{fig:B2-sensitivity}
\end{figure*}

\begin{figure*}
\centering
\subfloat[]{\includegraphics[scale=0.22]{Figures/NisVal-Deviation-Psat.png}}
\subfloat[]{\includegraphics[scale=0.22]{Figures/NisVal-Deviation-rhoL.png}}
\subfloat[]{\includegraphics[scale=0.22]{Figures/NisVal-Deviation-rhoV.png}}
\caption{
Sensitivity of the ITIC method to $T^\mathrm{sat}_\mathrm{est}$ for \textit{n}-dodecane. The ITIC method is applied using REFPROP values of $Z$ and $U^\mathrm{dep}$. The y-axis represents percent deviation of the corresponding property calculated using ITIC compared with REFPROP saturation data. Triangles pointing up or down represent ITIC results when $T^\mathrm{sat}_\mathrm{est}$ is increased or decreased by the percentage shown in the legend, respectively. $B_3$ is not included in Eq.~(\ref{eqn:rhoV}).
}
\label{fig:Nist-val-tsat-sensitivity}
\end{figure*}

\subsection{Sensitivity to Estimated Saturation Temperature} \label{sec:tsat-sensitivity}
As mentioned in Section~\ref{sec:ITIC-method}, saturation liquid densities in the ITIC method are fixed values at which we compute other saturation properties. This requires an initial estimate for saturation temperatures at the densities of interest.
 
It is important that the ITIC method does not depend strongly on the accuracy of $T^\mathrm{sat}_\mathrm{est}$. Figure~\ref{fig:Nist-val-tsat-sensitivity} demonstrates that deviations in $P^\mathrm{sat}$ are less than 1 \% and deviations in $\rho_\mathrm{liq}$ are less than 0.25 \% when errors in $T^\mathrm{sat}_\mathrm{est}$ are within 10 \%. Deviations in $\rho_\mathrm{vap}$ are less than 1 \%, except for the high temperature point for which deviations are smaller than 3 \%. This can be improved by including $B_3$. Typical errors in $T^\mathrm{sat}_\mathrm{est}$ are less than 1 \%, in which case the deviations for all three properties are nearly indistinguishable from the deviations resulting from numerical integration alone, i.e., those for 0 \% error in $T^\mathrm{sat}_\mathrm{est}$. 

Note that in Figure~\ref{fig:Nist-val-tsat-sensitivity}, isochoric/isothermal properties ($Z$ and $U^\mathrm{dep}$) used for determining saturation properties are obtained from REFPROP. If $T^\mathrm{sat}_\mathrm{est}$ percent deviation shown in the legend of Figure~\ref{fig:Nist-val-tsat-sensitivity}(a) is less than zero (i.e. $T^\mathrm{sat}_\mathrm{est} < T^\mathrm{sat}_\mathrm{REFPROP}$), some of the ITIC points are in metastable state. Since the REFPROP database does not provide $Z$ and $U^\mathrm{dep}$ for such points, a linear extrapolation of REFPROP data was used to approximate $Z$ and $U^\mathrm{dep}$. A similar sensitivity analysis using simulation results is included in supplementary material.

\section{Simulation Details} \label{sec:SimDetail}
In principle, both Monte Carlo and molecular dynamics methods can be used to simulate the $NVT$ state points required to construct the isothermal and isochoric paths in the ITIC method. In this study, the MC method is favored due to smaller uncertainties at low density. The Cassandra \cite{Shah2017} and GOMC (GPU Optimized Monte Carlo) \cite{Mick2013} packages are used to simulate several molecules in $NVT$ ensemble using united-atom potential models. In united-atom force fields, interaction sites may consist of a group of atoms, which is centered on the main atom of the group for the TraPPE-UA method \cite{Smit1998}. In the TraPPE-UA model van der Waals interactions are truncated at $1.4\,\mathrm{nm}$ and standard analytical long-range corrections are applied to compensate for truncation effects on energy and pressure\cite{allen2017}. Furthermore, the bond lengths are considered fixed and the bond energy is zero. This approximation results in smaller pressure fluctuations at low densities, but we note that the MC results at high densities were consistent with MD results simulated in Large-scale Atomic/Molecular Massively Parallel Simulator (LAMMPS) \cite{Plimpton2007} and GROMACS \cite{Lindahl2001} within their uncertainties.

For each compound, 26 $NVT$ points are simulated in order to obtain 5 saturation points, as illustrated in Figure~\ref{fig:ITICpathway}. The density of the isochore with highest density is chosen to match the experimental liquid density at the minimum reduced saturation temperature ($T_\mathrm{r}^\mathrm{min}$) of 0.45. Densities and temperatures of all simulated state points are listed in the supplementary material along with average pressures and average energies.

The Packmol \cite{martinez2009packmol} software is used to create the initial configurations for LAMMPS and GOMC simulations, while Cassandra and GROMACS simulations were initialized using internal capabilities of this software. These initialization methods were adequate for generating the highest density liquid phase configurations of the most complex molecules studied. However, for even more challenging systems where these techniques might fail, we recommend initializing at a lower density and slowly compressing the box size to the desired density. 

The simulation boxes typically contain 1200 sites except for the four simulations required for estimating $B_2$ at the isotherm temperature (the purple and green diamonds in Figure~\ref{fig:ITICpathway}) for which simulation boxes contain 4800 sites. Standard Periodic Boundary Conditions (PBCs) are used. Simulations are run for 10 million Monte Carlo steps, and the last 5 million MC steps are used for calculating the properties which ar stored every 50,000 MC steps. 


In order to approximate the computational cost of the ITIC method, \textit{n}-dodecane  coexistence points obtained at reduced temperatures of 0.65, 0.75, and 0.85 using  GEMC are compared with the ITIC coexistence points obtained at liquid densities corresponding to reduced temperatures of approximately 0.65, 0.75, and 0.85. This temperature range is chosen because both  GEMC and ITIC are reliable within $0.65<T_\mathrm{r}<0.85$. Cassandra package is used for both simulations using an AMD 1.3 GHz processor. 3,500 and 13,500 MC cycles are used for equilibration and production of GEMC simulation, using five block averages to characterize the uncertainty. The average run-time of the three GEMC simulations is 15.8 hours with each simulation running on a separate CPU core, resulting in an average $P^\mathrm{sat}$ uncertainty of 7.5 \% (relative standard error). On the other hand, running ITIC state points for 500 MC cycles of equilibration and 2000 MC cycles of production with four block averages reproduced the GEMC results with 7.1 \% $P^\mathrm{sat}$ uncertainty. The ITIC simulations were run on 20 CPU core. The maximum run-time (highest density and lowest temperature) of ITIC simulations is 18.9 hours. Therefore, when the number of available CPU cores is not limited, the ITIC method is approximately 20\% slower than GEMC. If ITIC coexistence points at reduced temperatures of 0.45 and 0.55 are to be included, the maximum run-time slightly increases (i.e. 22.3 hours $\approx$ 40 \% additional computational time compared to GEMC), whereas GEMC is not feasible for \textit{n}-dodecane, unless a thermodynamic integration approach (i.e. Gibbs-Duhem) is used to extend the lower temperature limit of GEMC.

\subsection{Internal Energy Departure Function Calculation}\label{sec:udepCalc}

Computing the internal energy departure function in Eq.~(\ref{eqn:AdepLiq2}) requires estimating the ideal gas energy $(U_{\mathrm{ig}})$ at each temperature simulated along a given isochore. The most rigorous approach to determine $U_{\mathrm{ig}}$ is by simulating a single molecule system at the corresponding temperature, such that
\begin{equation}\label{eqn:uDep single molecule}
U^{\mathrm{dep}} = \frac{E^{\mathrm{tot}} - N \times E^{N=1}}{NRT}
\end{equation}
where $E^{\mathrm{tot}}$ and $E^{N=1}$ are the total potential energy and the single molecule potential energy, respectively. Some caution should be exercised when computing $E^{N=1}$. For example, molecular dynamics simulations with a single molecule are ill-advised when performed with standard thermostats that couple many degrees of freedom to a single bath \cite{Merz2018}. For this purpose, we recommend using either chains of thermostats, Monte Carlo simulations, or stochastic (Langevin) dynamics \cite{Goga2012Langevin} to compute $E^{N=1}$.

The additional single molecule simulations equilibrate very quickly, such that the extra CPU time incurred to compute $E^{N=1}$ is not significant. However, a slightly simpler approach is to assume that $U_{\mathrm{ig}}$ is approximately equal to the intramolecular energy at the isochoric state point, such that
\begin{equation}
U^{\mathrm{dep}} = \frac{E^{\mathrm{tot}} - E^{\mathrm{bonded}} - E^{\mathrm{intra}}}{NRT}\label{eqn:uDepForm}
\end{equation}
where $E^{\mathrm{bonded}}$ and $E^{\mathrm{intra}}$ are, respectively, the bonded energy (bond, angle, and dihedral) and intramolecular pairwise energy (Coulombic and van der Waals) from the isochoric simulation. If the molecular simulation package does not provide an internal way of estimating $E^{\mathrm{intra}}$, a post-processing code is required to calculate this quantity. For example, LAMMPS simulations require this post-processing. Note that failure to subtract $E^{\mathrm{intra}}$ causes a significant error in vapor pressure.

We emphasize that Eq.~(\ref{eqn:uDepForm}) should only be applied with small molecules (i.e., 5 or fewer atoms along the backbone), where the molecular configurations are similar for the ideal gas and condensed phases. Typical errors in $P^{\mathrm{sat}}$ are between 10\% and 20\% when applying Eq.~(\ref{eqn:uDepForm}) to larger molecules, where the deviation increases with decreasing $T^{\mathrm{sat}}$.

Section \ref{sec:ExampleSim} utilizes both methods for demonstrative purposes, where the single molecule method is implemented for larger molecules. A more detailed comparison between the two methods of calculating $U^{\mathrm{dep}}$ (i.e., Eq.~(\ref{eqn:uDep single molecule})-(\ref{eqn:uDepForm})) is discussed in Supplementary Material.

%\subsection{Internal Energy Departure Function Calculation}\label{sec:udepCalc}
%The internal energy departure function in Eq.~(\ref{eqn:eqn8}) can be calculated for isochoric points using Eq.~(\ref{eqn:uDepForm})

%\begin{equation}
%U^{\mathrm{dep}} = \frac{E^{\mathrm{tot}} - E^{\mathrm{bonded}} - E^{\mathrm{intra}}}{NRT}\label{eqn:uDepForm}
%\end{equation}
%where $E^{\mathrm{tot}}$, $E^{\mathrm{bonded}}$, and $E^{\mathrm{intra}}$ are the total potential energy, bonded energy (bond, angle, and dihedral), and intramolecular pairwise energy (coulumbic and van der Waals). Failing to subtract $E^{\mathrm{intra}}$ causes a significant error in vapor pressure. A post-processing code is required to calculate this quantity, if the molecular simulation package does not provide an internal way of estimating $E^{\mathrm{intra}}$. For example, LAMMPS simulations require this post-processing.  In this case it is necessary to output the site coordinates periodically after the simulation reaches equilibrium. 

%An underlying assumption of Eq.~(\ref{eqn:eqn8}) is that the intramolecular energy (ideal gas contribution) does not depend on density of the system. This assumption might not hold true for dense systems and large molecules, where the overall configuration of moleucles, hence the intramolecular non-bonded and bonded energies, is affected by closeness of the molecules. A more rigorous way of calculating ideal gas energy is to obtain the total energy from simulation of a single molecule system. The internal energy departure function is calculated using

%\begin{equation}
%U^{\mathrm{dep}} = \frac{E^{\mathrm{tot}} - N \times E^{\mathrm{single\,molecule}}}{NRT}\label{eqn:uDepFormSingle}
%\end{equation}
%where $E^\mathrm{single\,molecule}$ represents the total potential energy of the single molecule simulation. Using single molecules approach to calculate $U^\mathrm{dep}$ requires performing single molecule simulations for ITIC points on isochores. Fortunately, these simulation equilibriate very fast, so the extra simulation time incurred as a result of using this approach is not significant. A comparison between the two methods of calculating $U^{\mathrm{dep}}$ is discussed in Supplementary Material.

%Todo: In Section~\ref{sec:ExampleSim}, we confirm that $U^\mathrm{dep}$ values from Eq.~(\ref{eqn:eqn8}) and single molecule approach are in agreement within their uncertainties.

\subsection{Bootstrapping Method for Uncertainty Calculation}\label{sec:bootstrapping}
Bootstrapping is used to estimate the statistical uncertainties \cite{Efron1981} in $T^\mathrm{sat}$, $P^\mathrm{sat}$, $\rho_\mathrm{vap}$, and $\Delta H_\mathrm{v}$. Note that the ITIC method determines saturation conditions at a fixed value of $\rho_{\mathrm{liq}}$ (equal to the isochoric density) and, therefore, the bootstrap uncertainty in $\rho_{\mathrm{liq}}$ is zero. Four series of independent $NVT$ simulations are performed for each compound using different random number generator seeds. Each series of $NVT$ simulations comprises 26 state points including four at $T_\mathrm{r}=0.9$ and three on isotherm used to estimate $B_2$. In order to increase the number of samples, the production data in each run is divided into two blocks. The ITIC analysis is performed using $NVT$ state points randomly selected from the eight blocks, and saturation properties are computed. This process is repeated 500 times resulting in 500 sample values for each saturation property. The 95 \% confidence intervals are then calculated from the resulting 500 ITIC outputs. 

The resulting uncertainties are used to generate error bars represented in Figure~\ref{fig:EXAMPLE-SIM/all}, however in most cases the error bars are smaller than the symbols. For greater clarity, uncertainties are tabulated in supplementary material for each property at each saturation condition.

\section{Calculation of Virial Coefficients} \label{sec:VirialCalc}
Mayer Sampling is a common approach for estimating virial coefficients of a given force field \cite{singh2004mayer}. For example, Kofke and Schultz implement this approach for \textit{n}-alkanes \cite{Schultz2010a}. Efforts like those of Kofke and Schultz could make simulations on the lower end of supercritical isotherm unnecessary \cite{barlow2015communication}, in addition to facilitating computations just below the critical temperature.  Furthermore, the higher virial coefficients play a significant role on their own merits in the development of high accuracy equations of state for simulation models \cite{thol2016equation}.

In this study, we use a simpler approach that is amenable for developing a correlation for $B_2$ and $B_3$ with respect to temperature. Second virial coefficients are estimated by calculating the intercept of $(Z-1)/\rho$ with respect to $\rho$. In principle, the slope of this line at zero density also gives the third virial coefficient. Figure~\ref{fig:TraPPE-C2-Z1rho-B2-B3} shows the accuracy of this method when used at various temperatures. The blue lines in Figure~\ref{fig:TraPPE-C2-Z1rho-B2-B3}(a) are obtained from Eq.~(\ref{eqn:Z1rhoB2B3})

\begin{equation}
\frac{Z-1}{\rho} = B_2 + B_3\rho \label{eqn:Z1rhoB2B3}
\end{equation}
where the intercept ($B_2$) and slope ($B_3$) correspond to Schultz's values \cite{Schultz2010a}.

Figure~\ref{fig:TraPPE-C2-Z1rho-B2-B3}(a) shows that for TraPPE-UA ethane at temperatures above $T_\mathrm{r}^{\mathrm{sat}}=0.85$, $B_2$ values calculated using this method agree with values reported by Schultz to within 2 \%. In Figure~\ref{fig:TraPPE-C2-Z1rho-B2-B3}(a), $Z$ at $T_\mathrm{r} = 0.8$ and $\rho \approx 0.085\,\mathrm{g/cm^3}$ is not consistent with the Schultz values due to proximity with the two-phase region. Therefore, using the lowest three densities would give a more accurate estimate for those temperatures. It is worth considering that the value of accurate virial coefficient characterization is enhanced in the context of the ITIC method.  

\begin{figure*}
\centering
\subfloat[]{\includegraphics[scale=0.20]{Figures/TraPPE-C2-Z1rho.png}}
\subfloat[]{\includegraphics[scale=0.20]{Figures/TraPPE-C2-B2.png}}
\subfloat[]{\includegraphics[scale=0.20]{Figures/TraPPE-C2-B3.png}}
\caption{
Panel \textbf{a)} shows the plot of $(Z-1)/\rho$ with respect to $\rho$ for TraPPE-UA ethane. Blue solid squares represent Schultz's $B_2$ values.~\cite{Schultz2010a}. Blue dashed lines represent Schultz values of $B_2$ (intercept) and $B_3$ (slope). Circles and diamonds are $NVT$ state points simulated with the GOMC package \cite{Mick2013}. Using circles in a) suffices to obtain accurate virial coefficients, therefore diamond points are are not used in $B_2$ and $B_3$ calculations. In panel \textbf{b)} and \textbf{c)} black squares represent the median of $B_2$ and $B_3$ when circle points \{1,2,3\}, \{1,2,3,4\}, \{2,3,4\}, and \{1,2,4\} from panel \textbf{a)} were used in linear regression according to Eq.(\ref{eqn:Z1rhoB2B3}). Error bars represent bootstrapped uncertainties. The blue circles in panel \textbf{b)} represent $B_2$ values obtained by Martin and Siepmann \cite{Martin1998} using a Monte Carlo method \cite{Harismiadis1994}.
}
\label{fig:TraPPE-C2-Z1rho-B2-B3}
\end{figure*}

According to Eq.~(\ref{eqn:rhoV}), it is important to have a correlation for $B_2$ and $B_3$ with respect to temperature, because $T^\mathrm{sat}$ estimates change after each iteration and updated values for $B_2$ and $B_3$ are needed. Recently, a Taylor Series expansion with Mayer Sampling approach has been utilized to generate correlations with respect to temperature for $B_2$ and $B_3$ \cite{Hatch2017}. In this study, we obtain such a correlation from the formula used in the DIPPR \cite{DIPPR2004} database, except the last term is omitted to decrease the number of parameters and avoid overfitting, as shown in Eq.~(\ref{eqn:b2form}) 

\begin{equation}
B_2=A+\frac{B}{T}+\frac{C}{T^3} \label{eqn:b2form}
\end{equation}

Eq.~(\ref{eqn:b2it}) and Eq.~(\ref{eqn:b2TrPoint9}) are obtained by inserting $B_2$ values extrapolated using Eq.~(\ref{eqn:Z1rhoB2B3}) and their corresponding temperatures into Eq.~(\ref{eqn:b2form}). 

\begin{equation}
B_2(T_{\mathrm{IT}})=A+\frac{B}{T_{\mathrm{IT}}}+\frac{C}{T_{\mathrm{IT}}^3} \label{eqn:b2it}
\end{equation}

\begin{equation}
B_2(T_{0.9})=A+\frac{B}{T_{0.9}}+\frac{C}{T_{0.9}^3} \label{eqn:b2TrPoint9}
\end{equation}
where $T_{0.9}$ is the temperature corresponding to reduced temperature of 0.9 and $T_\mathrm{IT}$ represents the isothermal temperature. 

Subtracting Eq.~(\ref{eqn:b2TrPoint9}) from Eq.~(\ref{eqn:b2it}) gives


\begin{equation}
B_2(T_{\mathrm{IT}})-B_2(T_{0.9})=B \left( \frac{1}{T_{\mathrm{IT}}}-\frac{1}{T_{0.9}} \right) +C \left( \frac{1}{T_{\mathrm{IT}}^3}-\frac{1}{T_{0.9}^3} \right) \label{eqn:b2subtract}
\end{equation}

Taking the derivative of $B_2$ with respect to $\beta$, as shown in Eq.~(\ref{eqn:dB2dbeta}) leads to the internal energy departure function

\begin{equation}
\rho \frac{\beta \partial B_2}{\partial \beta}=\rho \left( \frac{B}{T}+\frac{3C}{T^3}\right)=\frac{U-U_\mathrm{ig}}{RT} \label{eqn:b2uDep}
\end{equation}

Therefore, the intercept of $\frac{U-U_\mathrm{ig}}{\rho RT}$ with respect to $\rho$ gives the value of $\beta \frac{\partial B_2}{\partial \beta}$. Having this value can lead to Eq.~(\ref{eqn:b2pB2pBeta}) with two unknowns ($B$ and $C$)

\begin{equation}
\beta \frac{\partial B_2}{\partial \beta}=\frac{B}{T_{0.9}}+\frac{3C}{T_{0.9}^3} \label{eqn:b2pB2pBeta}
\end{equation}

Solving three equations (Eq.~(\ref{eqn:b2it})/(\ref{eqn:b2TrPoint9}), (\ref{eqn:b2subtract}), and (\ref{eqn:b2pB2pBeta})) with three unknowns gives the values of A, B, and C, hence a correlation for $B_2$ with respect to temperature is derived. Figure~\ref{fig:TraPPE-C2-Z1rho-B2-B3}(b) shows a correlation obtained by this method which is in good agreement with Schultz's simulation results \cite{Schultz2010a}.

$B_3$ calculation using Eq.~(\ref{eqn:Z1rhoB2B3}) deviates significantly from the rigorous values, as shown in Figure~\ref{fig:TraPPE-C2-Z1rho-B2-B3}(c). Therefore, $B_3$ values estimated this way are useful but should be regarded as ``effective" values that indirectly account for $B_4$ and higher order terms. On the other hand, more accurate representation of $(Z-1)/\rho$ is achieved using the $B_3^\mathrm{eff}$ from Eq.~(\ref{eqn:Z1rhoB2B3}) than using the rigorous $B_3$ or the rigorous $B_3$ and $B_4$ in combination, as shown in Figure~\ref{fig:FSE_TraPPE_C2_abc} (compare solid and dashed black lines with green line). Note that in the ITIC applications considered in this study, only second virial coefficient is used, therefore obtaining accurate $B_3$ is not a concern.

%For the current implementation of ITIC, Eq.~(\ref{eqn:Z1rhoB2B3}) with $B_3^\mathrm{eff}$ is used at $T_\mathrm{r}^\mathrm{sat} > 0.85$.

\section{Accurate Low Density Simulations}\label{sec:FSE}
%Todo: change "section" to "subsection" in the above line and maybe create another subsection for the above material
According to Figure~\ref{fig:B2-sensitivity}(a), $P^{\mathrm{sat}}$ accuracy is sensitive to accuracy of $B_2$ values at the isothermal temperature ($B_2^{\mathrm{IT}}$). This sensitivity is due to accumulation of errors when integrating along isotherm, such that an error in $B_2^{\mathrm{IT}}$ affects the $A^{\mathrm{dep}}$ values at all other points along the isotherm and isochores. Similarly, one would expect a significant influence from low density points, i.e. points 1, 2, and 3 in Figure~(\ref{fig:ITICpathway}). Therefore, it is important to investigate the factors affecting the accuracy of $Z$ at low densities on the isotherm. The factors considered in this study are system size, the choice of MD or MC, and the choice of fixed bonds or flexible bonds. 

The system size effects at low densities are demonstrated in Figure~\ref{fig:FSE_TraPPE_C2_abc}. Plot of $(Z-1)/\rho$ with respect to $\rho$ shown in Figure~\ref{fig:FSE_TraPPE_C2_abc}(a) demonstrates the effect of varying number of molecules in MD simulation of ethane with rigid bonds. Figure~\ref{fig:FSE_TraPPE_C2_abc}(a) demonstrates that, for the simulation times chosen, 3200 ethane molecules are necessary to obtain reliable estimates of $B_2$ and to match the $B_2+B_3 \rho+B_4 \rho^2$ line, which represents the rigorous values of $(Z-1)/\rho$. In the MD simulations shown in Figure~\ref{fig:FSE_TraPPE_C2_abc}(a) C-C bonds are held constant using the SHAKE algorithm \cite{Ryckaert1977}. 

The effect of using flexible bonds is shown in Figure 9(b). Two key limitations exist for obtaining reliable estimates with flexible bond MD simulations. First, the MD flexible uncertainties are considerably larger than the MD rigid uncertainties. Note that the same number of production steps were used to compute the uncertainties for both MD flexible and MD rigid, for a given value of N. Second, while all of the MD rigid simulations equilibrated in less than 1 ns, the MD flexible systems at the lowest densities required equilibration times between 24-47 ns (with 24 ns corresponding to N = 120). The slow equilibration for MD flexible simulations is presumably due to the small number of intermolecular collisions at low density relative to the large number of intramolecular collisions.

Figure~\ref{fig:FSE_TraPPE_C2_abc}(c) shows the low density $NVT$ state points simulated using GOMC \cite{Mick2013}. This plot shows that the MC method gives more reliable results than MD for low density $NVT$ state points. 
%Presumably, this is because MC codes calculate the pressure using the intermolecular virial only.
%Reviewer2: MC method are generally using the molecular virial route in which PV = NkT + W' where N is the number of molecules (not the number of atoms) and where the virial W' contains contributions from intermolecular forces only. 
%Table~\ref{tab:FSE} compares the uncertainties of $Z$ when using different simulation methods. $\mathrm{STD}_1$ represents the average of four relative standard deviations of $Z$ (i.e., $\mathrm{STD}/Z\times100 \, \%$), each calculated during a single run, while $\mathrm{STD}_2$ is the relative standard deviation of $Z$ from four separate runs. According to this table, the standard deviations from four replicate simulations ($\mathrm{STD}_2$) are much smaller than the average standard deviation for a single run ($\mathrm{STD}_1$). Therefore, Figure~\ref{fig:FSE_TraPPE_C2_abc} is plotted based on $\mathrm{STD}_2$ uncertainties. Table~\ref{tab:FSE} also shows that MC results have nearly an order of magnitude smaller $\mathrm{STD}_1$ and $\mathrm{STD}_2$ than rigid or flexible MD results when $N < 3200$.  
Therefore, we recommend using MC when simulating these low density points. The choice of MD or MC for other high density state points in ITIC method is less important, because they generally agree with each other within their uncertainties. %In this study, we use MC for all state points when computing VLE.

\begin{figure*}
\centering
\subfloat[MD rigid]{\includegraphics[scale=0.22]{Figures/FSE_TraPPE-C2_Lammps-rigid_IT.png}}
\subfloat[MD flexible]{\includegraphics[scale=0.22]{Figures/FSE_TraPPE-C2_Lammps-flex_IT.png}}
\subfloat[MC rigid]{\includegraphics[scale=0.22]{Figures/FSE_TraPPE-C2_GOMC_IT.png}}
\caption{ Effect of number of ethane molecules on compressibility factor at low densities at $T^{\mathrm{IT}}=360$. Panel \textbf{a)} is from MD with rigid bonds (using SHAKE algorithm \cite{Ryckaert1977} in LAMMPS), panel \textbf{b)} is from MD with flexible bonds in LAMMPS (harmonic potential using multiple-time-step algorithm RESPA \cite{tuckerman1992} algorithm), and panel \textbf{c)} is from MC with rigid bonds (GOMC). 
Solid black lines represent $B_2+B_3 \rho+B_4 \rho^2$ curve where $B_{2-4}$ are obtained from Schultz's work \cite{Schultz2010a}. Dashed black lines represent $B_2+B_3 \rho$ line where $B_{2-3}$ are obtained from Schultz's work. Solid black circle shows the Schultz's value of $B_2$. Dashed purple lines represent $B_2+B_3^\mathrm{eff}\rho$ where $B_2$ and $B_3^\mathrm{eff}$ are fit to four lowest density simulation values. Note that the increasing  deviation between black line and simulation points at higher densities is due to truncation of virial equation at $B_4$. The error bars illustrate the 95 \% confidence intervals calculated from four separate runs each consisting two blocks (8 samples). Number of MD steps used to calculate averages is inversely proportional to N with 6 million timesteps for N=120. Equilibration times were 1 ns for MD rigid and between 24-47 ns for MD flexible.
}
\label{fig:FSE_TraPPE_C2_abc}
\end{figure*}

\begin{figure*}[]
\subfloat[]{\includegraphics[scale=0.23]{Figures/Deviation-Psat.png}}
\subfloat[]{\includegraphics[scale=0.23]{Figures/Deviation-rhoL.png}}
\subfloat[]{\includegraphics[scale=0.23]{Figures/Deviation-rhoV.png}}
\caption{Comparison between ITIC (filled) with respect to GEMC and GCMC methods (unfilled). The y-axis represents deviation from REFPROP data. 
GEMC: TraPPE-UA \textit{n}-dodecane  (orange) \cite{Martin1998}, TraPPE-UA ethane (cyan) \cite{Martin1998}, TraPPE-UA isobutane (purple) \cite{Wick2000};
GCMC: TraPPE methane\cite{Shen2008} (blue), Mie-UA \textit{n}-dodecane (red) \cite{Potoff2009}, TIP4P/2005 water (green) \cite{Shen2008}, and TraPPE-UA isohexane (brown) \cite{Mick2017}. Black filled symbols represent ITIC results simulated with GROMACS \cite{Lindahl2001}. Black unfilled triangles represent TraPPE-UA \textit{n}-dodecane from Ref.~\cite{Ungerer2000}. $U^\mathrm{dep}$ is computed with Eq.~(\ref{eqn:uDep single molecule}) for \textit{n}-dodecane and isohexane by performing single molecule simulations, while $U^\mathrm{dep}$ is computed with Eq.~(\ref{eqn:uDepForm}) for other compounds. Error bars for ITIC data (typically smaller than symbol sizes) denote 95 \% confidence intervals assuming zero variation in $T^\mathrm{sat}$. Due to some ambiguity regarding whether literature uncertainties correspond to standard deviations or 95 \% confidence intervals, error bars for literature values represent uncertainties as reported by the respective authors.
}
\label{fig:EXAMPLE-SIM/Deviation-Psat-rhoL-rhoV}
\end{figure*}

\begin{figure*}[]
\centering
\subfloat[]{\includegraphics[scale=0.30]{Figures/EXAMPLE-SIM_GEMC_psat.png}}\label{aa}
\subfloat[]{\includegraphics[scale=0.30]{Figures/EXAMPLE-SIM_GEMC_trho.png}}\label{bb}\\
\subfloat[]{\includegraphics[scale=0.30]{Figures/EXAMPLE-SIM_GCMC_psat.png}}\label{cc}
\subfloat[]{\includegraphics[scale=0.30]{Figures/EXAMPLE-SIM_GCMC_trho.png}}\label{dd}
\caption{
Comparison between ITIC method and Monte Carlo methods: GEMC (TraPPE-UA \textit{n}-dodecane \cite{Martin1998}, TraPPE-UA ethane \cite{Martin1998}, and TraPPE-UA isobutane \cite{trappe-isobutane-validation}), and GCMC (TraPPE-UA methane \cite{Shen2008}, Mie-UA \textit{n}-dodecane \cite{Potoff2009}, TIP4P/2005 water \cite{Shen2008}, and TraPPE-UA isohexane \cite{Mick2017}). $B_2$ values at saturation temperatures were obtained using low density simulations described in Section~\ref{sec:VirialCalc}, except for TIP4P/2005 simulation where $B_2$ correlation is obtained from Ref.~\cite{Benjamin2007,Chialvo2006}. Black and red filled symbols show the critical points from literature and ITIC, respectively.
}
\label{fig:EXAMPLE-SIM/all}
\end{figure*}

\section{Example Simulations} \label{sec:ExampleSim}
The TraPPE-UA \cite{Martin1998,Martin1999,Wick2000}, Mie-UA \cite{Potoff2009,Mick2017,Barhaghi2017,Mick2015}, and TIP4P/2005 \cite{Abascal2005} models were chosen for the purpose of testing the ITIC method due to the availability of literature vapor-liquid coexistence simulation results. Figures ~\ref{fig:EXAMPLE-SIM/Deviation-Psat-rhoL-rhoV} and \ref{fig:EXAMPLE-SIM/all} demonstrate good agreement between traditional GEMC/GCMC methods and the ITIC approach using both MC and MD. The ITIC and literature values (GEMC/GCMC) typically agree to within less than 0.5 \% for $\rho_\mathrm{liq}$ and within a few percent for $P^\mathrm{sat}$ and $\rho_\mathrm{liq}$.

Figure~\ref{fig:EXAMPLE-SIM/Deviation-Psat-rhoL-rhoV} provides a quantitative comparison between ITIC method and traditional vapor-liquid coexistence Monte Carlo methods. This figure compares the deviations of ITIC and MC methods from REFPROP values as a baseline to make the magnitudes of the discrepancies more clear. Figure~\ref{fig:EXAMPLE-SIM/all} shows the Clausius-Clapeyron and coexistence curves for all example simulations compared to MC methods. In all ITIC calculations, $B_2$ is included in Eq.~(\ref{eqn:rhoV}) and Eq.~(\ref{eqn:psat}), while $B_3$ is set to zero for simplicity. Initial $T^\mathrm{sat}$ values for all the compounds shown in Figures ~\ref{fig:EXAMPLE-SIM/Deviation-Psat-rhoL-rhoV} and \ref{fig:EXAMPLE-SIM/all} were obtained from the DIPPR \cite{DIPPR2004} database. Complete information about chosen ITIC state points as well as the results of $NVT$ simulations is included in Supplementary Materials.

Saturation points calculated using the ITIC method are compared against TraPPE-UA results obtained using GEMC which are available from the TraPPE website \cite{eggimann2014}. Figure~ \ref{fig:EXAMPLE-SIM/Deviation-Psat-rhoL-rhoV}, \ref{fig:EXAMPLE-SIM/all}(a), and \ref{fig:EXAMPLE-SIM/all}(b) compare the ITIC and GEMC results for pure ethane, \textit{n}-dodecane, and isobutane systems. $NVT$ simulations at ITIC state points are performed using the Cassandra Monte Carlo \cite{Shah2017} and GROMACS molecular dynamics \cite{Lindahl2001} packages. 

In Figure~\ref{fig:EXAMPLE-SIM/Deviation-Psat-rhoL-rhoV}, the ITIC results of TraPPE-UA \textit{n}-dodecane are also compared with the Gibbs-Duhem integration method \cite{Ungerer2000}. Both methods provide a similar lower temperature limit and they are in relatively good agreement. Note that ITIC results for TraPPE-UA ethane are obtained near the triple point (i.e., $T^\mathrm{sat} \approx 95 K$). This demonstrates that ITIC can be applied for $T_\mathrm{r}^\mathrm{sat} \approx 0.3$.

The ITIC method was also compared to histogram-reweighting GCMC provided in Figure~\ref{fig:EXAMPLE-SIM/all}(c) and Figure~\ref{fig:EXAMPLE-SIM/all}(d). GCMC results for Mie-UA \textit{n}-dodecane are not available below a minimum reduced temperature ($T_\mathrm{r}^{\mathrm{min}}$) of 0.67, however the ITIC method allowed us to calculate vapor pressure and liquid densities for reduced temperatures as low as 0.45. 

In order to validate the ITIC method for polar molecules, the results of the ITIC method using TIP4P/2005 water simulated in Cassandra were compared against TIP4P/2005 data from the NIST Standard Reference Simulation Website \cite{Shen2008} simulated using grand-canonical Wang-Landau/Transition-matrix Monte Carlo and histogram re-weighting. Figure~ \ref{fig:EXAMPLE-SIM/Deviation-Psat-rhoL-rhoV}, \ref{fig:EXAMPLE-SIM/all}(c), and \ref{fig:EXAMPLE-SIM/all}(d) show the agreement between the two methods for TIP4P/2005 water. The absolute average percent deviation between vapor pressure calculated using ITIC method and GCMC method for TIP4P/2005 water shown in Figure~ \ref{fig:EXAMPLE-SIM/Deviation-Psat-rhoL-rhoV}(a) is less than 1 \%. This agreement shows that second virial coefficient can be obtained using Eq.~(\ref{eqn:Z1rhoB2B3}) for TIP4P/2005 model.

Figure~\ref{fig:EXAMPLE-SIM/all} includes the critical points obtained using the method described in Section~\ref{sec:ITIC-method}. The ITIC coexistence points 
shown in this figure do not exceed $T_\mathrm{r}^\mathrm{sat} \approx 0.85$, the estimated critical properties are subject to larger uncertainties and possible systematic deviations. In the case of TIP4P/2005 water, critical point calculation requires a more suitable method as shown in Ref.~\cite{Vega2006}. Accurate estimation of critical points by molecular simulation requires a careful and deliberate effort that includes accounting for system size effects \cite{orkoulas2001precise}. That effort goes beyond the scope of the current manuscript.

%Prerev: Figure~\ref{fig:EXAMPLE-SIM/all} includes the critical points obtained using the method described in Section~\ref{sec:ITIC-method}. Even though the ITIC coexistence points shown in this figure do not exceed $T_\mathrm{r}^\mathrm{sat} \approx 0.85$, acceptable critical properties were obtained, with the exception of TIP4P/2005 water. A more suitable method has been used in Ref.~\cite{Vega2006} to calculate critical properties of water.

One limitation of the ITIC approach is the need for a reasonable value of $T_\mathrm{est}^\mathrm{sat}$. The ITIC calculations shown so far are done for well-known molecules for which extensive experimental data are available. All force fields considered (TraPPE-UA, Mie-UA, TIP4P/2005) provide accurate representation of the $T^\mathrm{sat}$ vs. $\rho_\mathrm{liq}$ curve compared to experimental data. Therefore, the $T_\mathrm{est}^\mathrm{sat}$ values for these compounds were obtained from DIPPR database. However, it is important to make sure that ITIC method also works for the molecules for which experimental data are not available. For example, 1-naphthalenyl, 4-phenanthrenyl butane is a large aromatic with 5 rings and 28 united-atom sites for which, to the best of our knowledge, no experimental data is available. In this case, a simple linear extrapolation using two points (black (x) symbols in Figure~\ref{fig:Ex_Sim_TraPPE-1p4nB}(a)) along the isochore is used to obtain $T_\mathrm{est}^\mathrm{sat}$, i.e. the temperature at which $Z\approx0$. Once $T_\mathrm{est}^\mathrm{sat}$ is calculated, the procedure in Figure~2 is followed. Figure~\ref{fig:Ex_Sim_TraPPE-1p4nB}(b-c) shows good agreement between the ITIC method with $T_\mathrm{est}^\mathrm{sat}$ as above and both GCMC and GEMC results obtained using GOMC.

Alternatively, one can improve ITIC results when a reasonable estimate for $T_\mathrm{est}^\mathrm{sat}$ is not available, by running the ITIC procedure iteratively, i.e. using $T^\mathrm{sat}$ from the previous iteration. It's worth mentioning that we do not need to resimulate the isotherms, and the isochoric information from previous iterations can potentially help improve the integration accuracy along the isochores. 

The isothermal/isochoric plots of Helmholtz energy departure function, compressibility factor, and internal energy departure function as well as plots of second virial coefficient and heat of vaporization for all example simulations are included in supplementary material. Also included in supplementary material are tables containing ITIC results for all example simulations.


\begin{figure*}[]
\centering
\subfloat[]{\includegraphics[scale=0.20]{Figures/Ex_Sim_TraPPE-1p4nB_zt.png}}\label{cc}
\subfloat[]{\includegraphics[scale=0.20]{Figures/Ex_Sim_TraPPE-1p4nB_psat.png}}\label{aa}
\subfloat[]{\includegraphics[scale=0.20]{Figures/Ex_Sim_TraPPE-1p4nB_trho.png}}\label{bb}
\caption{
Simulation of 1-naphthalenyl,4-phenanthrenyl butane based on an extended TraPPE-UA model \cite{Yiannourakou2018}. Black (x) symbols are simulated at two arbitrarily chosen temperatures to obtain $T_\mathrm{est}^\mathrm{sat}$ (black circles) for each isochore. The ITIC, GCMC and GEMC results (black triangle) are simulated in this study using GOMC. Blue triangles are GEMC data obtained from Ref. \cite{Yiannourakou2018}.
}
\label{fig:Ex_Sim_TraPPE-1p4nB}
\end{figure*}

\section{Conclusions} \label{sec:conclusion} 
The ITIC method is shown to be a reliable alternative for phase equilibrium calculations. In the absence of simulation uncertainty, i.e. when REFPROP data was used as input, the vapor pressure calculated by the ITIC method with 9 points on isotherm and 3 points on isochore reproduces NIST REFPROP vapor pressure within 1 \% deviation. In applications where simulation uncertainty is significant, ITIC is sensitive to low density $NVT$ simulations, but the noise at low densities can be addressed by simulating larger systems, and preferring $NVT$ Monte Carlo method when feasible.

It is important for engineering applications to be able to simulate systems near the triple point, i.e., at temperatures as low as $T_\mathrm{r} = 0.3$ to $0.45$.  Monte Carlo methods such as GEMC and GCMC usually have a minimum reduced temperature limit of about 0.6, due to the insertion/transfer moves, unless combined with thermodynamic integration. The ITIC method, hence, outperforms GEMC and GCMC when $T_\mathrm{r}<0.6$, while attaining a similar lower temperature limit as GEMC-TI ($T_\mathrm{r} = 0.3$). The ITIC method, on the other hand, is less favorable at high reduced temperatures, especially above $T_\mathrm{r}=0.85$, mostly due to lack of a convenient method to characterize the virial coefficients. In addition, ITIC requires high temperature high pressure property estimates, which provide additional information for force field characterization.



The presentation here has focused primarily on GEMC as a basis for comparison, owing to its common application to this purpose and reader familiarity. Our comparisons show that ITIC is moderately more computationally expensive than GEMC, but that the added expense is worthwhile because it provides simulation results throughout phase space and accesses lower reduced temperatures. Other approaches, such as GEMC combined with Gibbs-Duhem integration could address the lower temperatures, but the computational expense would then approach that of ITIC, but still not provide simulation results away from the coexistence curve.


In conclusion, ITIC can easily be implemented from $T_\mathrm{r} = 0.45$ to $0.85$ with approximately 40 \% additional computational time over the 0.6 to 0.85 temperature range using GEMC. If temperatures above 0.85 are required, it is recommended to approach the problem of coexistence calculation with a combination of Monte Carlo (GEMC or GCMC) and isothermal-isochoric integration. If a single method is preferred, or if MD is the preferred simulation method, ITIC has notable advantages. These advantages could be enhanced over time with the availability of rigorous higher order virial coefficients for broader ranges of molecular types. 

\section{Acknowledgments}

This research was performed while R.A.M. held a National Research Council (NRC) Postdoctoral Research Associateship at the National Institute of Standards and Technology (NIST). Contribution of NIST, an agency of the United States government; not subject to copyright in the United States. We would like to thank the reviewers whose comments helped improve this manuscript as well as Mr. Mohammad Soroush Barhaghi for providing GCMC data used in Figure~(12).
%%%

\section{Supplementary Material} \label{sec:SupMat} 
See supplementary material for 
%density, temperature, compressibility factor, and energies of simulated state points for all simulated compounds, as well as 
the isothermal/isochoric plots of $A^{\mathrm{dep}}$, $U^{\mathrm{dep}}$, $Z$, and plots of $\Delta H_{\mathrm{v}}$, and $B_2$ for all example simulations. Also included are data shown in Figure~\ref{fig:Nist-Val-Deviation} and figures of $T^\mathrm{sat}_\mathrm{est}$ sensitivity study using simulation data. The ITIC code is avilable at \url{https://github.com/mostafa-razavi/ITIC}

%Todo: make this an actual link so the reader can open it from PDF

\section{References} \label{sec:ref} 

%\section*{References}

\bibliography{ITIC-Paper}

\end{document}
